name: Release

on:
  release:
    types: [prereleased,released] 
  workflow_dispatch:
    inputs:
      source:
        description: 'Binaries Source'
        required: true
        default: 'build'
        type: choice
        options:
          - build
          - release
          - prerelease
      tag:
        description: 'Docker Tag (for prerelease source)'
        required: true
        default: 'preview'    
jobs:
  # ç‰ˆæœ¬æ›´æ–°ï¼ˆåœ¨æž„å»ºä¹‹å‰ï¼‰
  update-version:
    if: github.event_name == 'release' || github.event_name == 'prerelease'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Extract version from tag and update file
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION=$(echo "$TAG_NAME" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-.*/\1/')
          echo "Extracted version: $VERSION"
          IS_PRERELEASE="${{ github.event.release.prerelease }}"
          echo "Is prerelease: $IS_PRERELEASE"

          # Switch to branch to allow pushing
          git checkout main || git checkout master
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          CHANGES=0

          # 1. Check and update mediaunlock.go
          CURRENT_VERSION=$(grep '^[[:space:]]*Version[[:space:]]*=' checks/mediaunlock.go | sed -E 's/.*Version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/')
          echo "Current version in file: $CURRENT_VERSION"
          
          if [ "$VERSION" != "$CURRENT_VERSION" ]; then
            echo "Version mismatch. Updating from $CURRENT_VERSION to $VERSION"
            sed -i "s/Version\s*=\s*\"[^\"]*\"/Version          = \"$VERSION\"/" checks/mediaunlock.go
            git add checks/mediaunlock.go
            CHANGES=1
          else
            echo "Version in mediaunlock.go is already up to date"
          fi
          
          # 2. Update VERSION file only if it's not a prerelease
          if [ "$IS_PRERELEASE" = "false" ]; then
            if [ -f VERSION ]; then
              FILE_TAG=$(cat VERSION)
            else
              FILE_TAG=""
            fi

            if [ "$TAG_NAME" != "$FILE_TAG" ]; then
              echo "Not a prerelease, updating VERSION file with $TAG_NAME"
              echo "$TAG_NAME" > VERSION
              echo "VERSION file content: $(cat VERSION)"
              git add VERSION
              CHANGES=1
            else
              echo "VERSION file is already up to date"
            fi
          else
            echo "Prerelease detected, skipping VERSION file update"
          fi

          # 3. Commit and push if any changes were made
          if [ "$CHANGES" -eq 1 ]; then
            git commit -m "Update version to $VERSION"
            git push origin HEAD
            echo "Version updated and committed"
          else
            echo "Nothing to commit, all versions are up to date."
          fi
        shell: bash

  # å¹¶è¡Œæž„å»ºä¸åŒå¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    needs: update-version
    if: |
      always() && 
      (needs.update-version.result == 'success' || needs.update-version.result == 'skipped') &&
      (github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.source == 'build'))
    strategy:
      matrix:
        project: [cli, monitor]
        platform: [
          # ä¸»è¦å¹³å°
          linux-amd64, linux-arm64, linux-386, linux-arm7, linux-arm6, linux-arm5,
          linux-loong64, linux-mips, linux-mips64, linux-mips64le, linux-mipsle,
          linux-ppc64, linux-ppc64le, linux-riscv64, linux-s390x,
          darwin-amd64, darwin-arm64,
          windows-amd64, windows-arm64, windows-386, windows-arm7, windows-arm6, windows-arm5,
          freebsd-amd64, freebsd-arm64, freebsd-386, freebsd-arm7, freebsd-arm6, freebsd-arm5, freebsd-riscv64,
          netbsd-amd64, netbsd-arm64, netbsd-386, netbsd-arm7, netbsd-arm6, netbsd-arm5,
          openbsd-amd64, openbsd-arm64, openbsd-386, openbsd-arm7, openbsd-arm6, openbsd-arm5, openbsd-ppc64
        ]
        include:
          # Androidå¹³å°éœ€è¦CGOæ”¯æŒ
          - project: cli
            platform: android-arm64
            os: android
            arch: arm64
            cgo: true
            api_level: 21
          - project: cli
            platform: android-amd64
            os: android
            arch: amd64
            cgo: true
            api_level: 21
          - project: cli
            platform: android-arm7
            os: android
            arch: arm
            cgo: true
            api_level: 21
            goarm: 7
          - project: cli
            platform: android-arm6
            os: android
            arch: arm
            cgo: true
            api_level: 21
            goarm: 6
          - project: cli
            platform: android-arm5
            os: android
            arch: arm
            cgo: true
            api_level: 21
            goarm: 5
          - project: cli
            platform: android-386
            os: android
            arch: 386
            cgo: true
            api_level: 21
          - project: monitor
            platform: android-arm64
            os: android
            arch: arm64
            cgo: true
            api_level: 21
          - project: monitor
            platform: android-amd64
            os: android
            arch: amd64
            cgo: true
            api_level: 21
          - project: monitor
            platform: android-arm7
            os: android
            arch: arm
            cgo: true
            api_level: 21
            goarm: 7
          - project: monitor
            platform: android-arm6
            os: android
            arch: arm
            cgo: true
            api_level: 21
            goarm: 6
          - project: monitor
            platform: android-arm5
            os: android
            arch: arm
            cgo: true
            api_level: 21
            goarm: 5
          - project: monitor
            platform: android-386
            os: android
            arch: 386
            cgo: true
            api_level: 21
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'
          cache: true

      - name: Cache Go Build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: ${{ runner.os }}-go-build-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-build-

      - name: Cache Android NDK
        if: matrix.cgo == true
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: /home/runner/android-ndk
          key: android-ndk-r27d

      - name: Setup Android NDK (for Android builds)
        if: matrix.cgo == true && steps.cache-ndk.outputs.cache-hit != 'true'
        run: |
          mkdir -p $HOME/android-ndk
          wget https://dl.google.com/android/repository/android-ndk-r27d-linux.zip
          unzip -q android-ndk-r27d-linux.zip -d $HOME/android-ndk
          mv $HOME/android-ndk/android-ndk-r27d $HOME/android-ndk/ndk
          
      - name: Set NDK Environment Variables
        if: matrix.cgo == true
        run: |
          echo "NDK_ROOT=$HOME/android-ndk/ndk" >> $GITHUB_ENV
          echo "PATH=$PATH:$HOME/android-ndk/ndk/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_ENV

      - name: Build binary
        run: |
          cd ${{ matrix.project }}
          mkdir -p build
          
          # è®¾ç½®æž„å»ºå‚æ•°
          if [ "${{ matrix.platform }}" = "android-arm64" ]; then
            export GOOS=android GOARCH=arm64 CGO_ENABLED=1
            export CC=aarch64-linux-android${{ matrix.api_level }}-clang CXX=aarch64-linux-android${{ matrix.api_level }}-clang++
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_android_arm64"
          elif [ "${{ matrix.platform }}" = "android-amd64" ]; then
            export GOOS=android GOARCH=amd64 CGO_ENABLED=1
            export CC=x86_64-linux-android${{ matrix.api_level }}-clang CXX=x86_64-linux-android${{ matrix.api_level }}-clang++
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_android_amd64"
          elif [ "${{ matrix.platform }}" = "android-arm7" ]; then
            export GOOS=android GOARCH=arm CGO_ENABLED=1 GOARM=7
            export CC=armv7a-linux-androideabi${{ matrix.api_level }}-clang CXX=armv7a-linux-androideabi${{ matrix.api_level }}-clang++
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_android_arm7"
          elif [ "${{ matrix.platform }}" = "android-arm6" ]; then
            export GOOS=android GOARCH=arm CGO_ENABLED=1 GOARM=6
            export CC=armv7a-linux-androideabi${{ matrix.api_level }}-clang CXX=armv7a-linux-androideabi${{ matrix.api_level }}-clang++
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_android_arm6"
          elif [ "${{ matrix.platform }}" = "android-arm5" ]; then
            export GOOS=android GOARCH=arm CGO_ENABLED=1 GOARM=5
            export CC=armv7a-linux-androideabi${{ matrix.api_level }}-clang CXX=armv7a-linux-androideabi${{ matrix.api_level }}-clang++
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_android_arm5"
          elif [ "${{ matrix.platform }}" = "android-386" ]; then
            export GOOS=android GOARCH=386 CGO_ENABLED=1
            export CC=i686-linux-android${{ matrix.api_level }}-clang CXX=i686-linux-android${{ matrix.api_level }}-clang++
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_android_386"
          elif [ "${{ matrix.platform }}" = "linux-amd64" ]; then
            export GOOS=linux GOARCH=amd64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_amd64"
          elif [ "${{ matrix.platform }}" = "linux-arm64" ]; then
            export GOOS=linux GOARCH=arm64 CGO_ENABLED=0
            export GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_arm64"
          elif [ "${{ matrix.platform }}" = "linux-386" ]; then
            export GOOS=linux GOARCH=386 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_386"
          elif [ "${{ matrix.platform }}" = "linux-arm7" ]; then
            export GOOS=linux GOARCH=arm CGO_ENABLED=0 GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_arm7"
          elif [ "${{ matrix.platform }}" = "linux-arm6" ]; then
            export GOOS=linux GOARCH=arm CGO_ENABLED=0 GOARM=6
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_arm6"
          elif [ "${{ matrix.platform }}" = "linux-arm5" ]; then
            export GOOS=linux GOARCH=arm CGO_ENABLED=0 GOARM=5
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_arm5"
          elif [ "${{ matrix.platform }}" = "linux-loong64" ]; then
            export GOOS=linux GOARCH=loong64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_loong64"
          elif [ "${{ matrix.platform }}" = "linux-mips" ]; then
            export GOOS=linux GOARCH=mips CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_mips"
          elif [ "${{ matrix.platform }}" = "linux-mips64" ]; then
            export GOOS=linux GOARCH=mips64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_mips64"
          elif [ "${{ matrix.platform }}" = "linux-mips64le" ]; then
            export GOOS=linux GOARCH=mips64le CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_mips64le"
          elif [ "${{ matrix.platform }}" = "linux-mipsle" ]; then
            export GOOS=linux GOARCH=mipsle CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_mipsle"
          elif [ "${{ matrix.platform }}" = "linux-ppc64" ]; then
            export GOOS=linux GOARCH=ppc64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_ppc64"
          elif [ "${{ matrix.platform }}" = "linux-ppc64le" ]; then
            export GOOS=linux GOARCH=ppc64le CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_ppc64le"
          elif [ "${{ matrix.platform }}" = "linux-riscv64" ]; then
            export GOOS=linux GOARCH=riscv64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_riscv64"
          elif [ "${{ matrix.platform }}" = "linux-s390x" ]; then
            export GOOS=linux GOARCH=s390x CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_linux_s390x"
          elif [ "${{ matrix.platform }}" = "darwin-amd64" ]; then
            export GOOS=darwin GOARCH=amd64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_darwin_amd64"
          elif [ "${{ matrix.platform }}" = "darwin-arm64" ]; then
            export GOOS=darwin GOARCH=arm64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_darwin_arm64"
          elif [ "${{ matrix.platform }}" = "windows-amd64" ]; then
            export GOOS=windows GOARCH=amd64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_windows_amd64.exe"
          elif [ "${{ matrix.platform }}" = "windows-arm64" ]; then
            export GOOS=windows GOARCH=arm64 CGO_ENABLED=0
            export GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_windows_arm64.exe"
          elif [ "${{ matrix.platform }}" = "windows-386" ]; then
            export GOOS=windows GOARCH=386 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_windows_386.exe"
          elif [ "${{ matrix.platform }}" = "windows-arm7" ]; then
            export GOOS=windows GOARCH=arm CGO_ENABLED=0 GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_windows_arm7.exe"
          elif [ "${{ matrix.platform }}" = "windows-arm6" ]; then
            export GOOS=windows GOARCH=arm CGO_ENABLED=0 GOARM=6
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_windows_arm6.exe"
          elif [ "${{ matrix.platform }}" = "windows-arm5" ]; then
            export GOOS=windows GOARCH=arm CGO_ENABLED=0 GOARM=5
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_windows_arm5.exe"
          elif [ "${{ matrix.platform }}" = "freebsd-amd64" ]; then
            export GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_amd64"
          elif [ "${{ matrix.platform }}" = "freebsd-arm64" ]; then
            export GOOS=freebsd GOARCH=arm64 CGO_ENABLED=0
            export GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_arm64"
          elif [ "${{ matrix.platform }}" = "freebsd-386" ]; then
            export GOOS=freebsd GOARCH=386 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_386"
          elif [ "${{ matrix.platform }}" = "freebsd-arm7" ]; then
            export GOOS=freebsd GOARCH=arm CGO_ENABLED=0 GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_arm7"
          elif [ "${{ matrix.platform }}" = "freebsd-arm6" ]; then
            export GOOS=freebsd GOARCH=arm CGO_ENABLED=0 GOARM=6
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_arm6"
          elif [ "${{ matrix.platform }}" = "freebsd-arm5" ]; then
            export GOOS=freebsd GOARCH=arm CGO_ENABLED=0 GOARM=5
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_arm5"
          elif [ "${{ matrix.platform }}" = "freebsd-riscv64" ]; then
            export GOOS=freebsd GOARCH=riscv64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_freebsd_riscv64"
          elif [ "${{ matrix.platform }}" = "netbsd-amd64" ]; then
            export GOOS=netbsd GOARCH=amd64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_netbsd_amd64"
          elif [ "${{ matrix.platform }}" = "netbsd-arm64" ]; then
            export GOOS=netbsd GOARCH=arm64 CGO_ENABLED=0
            export GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_netbsd_arm64"
          elif [ "${{ matrix.platform }}" = "netbsd-386" ]; then
            export GOOS=netbsd GOARCH=386 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_netbsd_386"
          elif [ "${{ matrix.platform }}" = "netbsd-arm7" ]; then
            export GOOS=netbsd GOARCH=arm CGO_ENABLED=0 GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_netbsd_arm7"
          elif [ "${{ matrix.platform }}" = "netbsd-arm6" ]; then
            export GOOS=netbsd GOARCH=arm CGO_ENABLED=0 GOARM=6
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_netbsd_arm6"
          elif [ "${{ matrix.platform }}" = "netbsd-arm5" ]; then
            export GOOS=netbsd GOARCH=arm CGO_ENABLED=0 GOARM=5
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_netbsd_arm5"
          elif [ "${{ matrix.platform }}" = "openbsd-amd64" ]; then
            export GOOS=openbsd GOARCH=amd64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_amd64"
          elif [ "${{ matrix.platform }}" = "openbsd-arm64" ]; then
            export GOOS=openbsd GOARCH=arm64 CGO_ENABLED=0
            export GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_arm64"
          elif [ "${{ matrix.platform }}" = "openbsd-386" ]; then
            export GOOS=openbsd GOARCH=386 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_386"
          elif [ "${{ matrix.platform }}" = "openbsd-arm7" ]; then
            export GOOS=openbsd GOARCH=arm CGO_ENABLED=0 GOARM=7
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_arm7"
          elif [ "${{ matrix.platform }}" = "openbsd-arm6" ]; then
            export GOOS=openbsd GOARCH=arm CGO_ENABLED=0 GOARM=6
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_arm6"
          elif [ "${{ matrix.platform }}" = "openbsd-arm5" ]; then
            export GOOS=openbsd GOARCH=arm CGO_ENABLED=0 GOARM=5
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_arm5"
          elif [ "${{ matrix.platform }}" = "openbsd-ppc64" ]; then
            export GOOS=openbsd GOARCH=ppc64 CGO_ENABLED=0
            BINARY_NAME="unlock-${{ matrix.project == 'cli' && 'test' || 'monitor' }}_openbsd_ppc64"
          else
            echo "âŒ Unsupported platform: ${{ matrix.platform }}"
            exit 1
          fi
          
          # æž„å»ºæ ‡å¿—
          FLAGS="-w -s"
          if [ "${{ matrix.project }}" = "monitor" ]; then
            FLAGS="$FLAGS -X 'main.buildTime=$(date '+%Y-%m-%d %H:%M:%SZ')'"
          fi
          
          # æ‰§è¡Œæž„å»º
          echo "ðŸ”¨ Building ${{ matrix.project }} for ${{ matrix.platform }}..."
          echo "Environment: GOOS=$GOOS, GOARCH=$GOARCH, CGO_ENABLED=$CGO_ENABLED"
          if [ "$GOARM" != "" ]; then
            echo "GOARM=$GOARM"
          fi
          
          if [ "${{ matrix.cgo }}" = "true" ]; then
            go build -tags netcgo -ldflags="$FLAGS" -o "build/$BINARY_NAME" .
          else
            go build -ldflags="$FLAGS" -o "build/$BINARY_NAME" .
          fi
          
          echo "âœ… Built: $BINARY_NAME"
          ls -la build/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-${{ matrix.platform }}
          path: ${{ matrix.project }}/build/
          retention-days: 1

  # å‘å¸ƒé˜¶æ®µ
  release:
    needs: build
    if: github.event_name == 'release' || github.event_name == 'prerelease'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Upload to release
        run: |
          echo "ðŸ“¤ Uploading all binaries to release..."
          
          # éåŽ†æ‰€æœ‰ä¸‹è½½çš„artifacts
          for artifact_dir in artifacts/*/; do
            if [ -d "$artifact_dir" ]; then
              echo "Processing $artifact_dir"
              for file in "$artifact_dir"*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  echo "Uploading $filename..."
                  
                  response=$(curl -s --fail --retry 3 --retry-delay 0 -X POST \
                    -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Content-Type: application/octet-stream" \
                    --data-binary "@$file" \
                    "https://uploads.github.com/repos/${{ github.repository }}/releases/${{ github.event.release.id }}/assets?name=$filename")
                  
                  if [ $? -eq 0 ]; then
                    echo "âœ… Successfully uploaded $filename"
                  else
                    echo "âŒ Failed to upload $filename: $response"
                    exit 1
                  fi
                fi
              done
            fi
          done
          
          echo "ðŸŽ‰ All binaries uploaded successfully!"

      - name: Build Summary
        run: |
          echo "ðŸ“Š Build Summary:"
          echo "=================="
          echo "Total artifacts downloaded:"
          ls -la artifacts/
          echo "=================="
          echo "ðŸŽ¯ Release build and upload completed successfully!"

  # æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
  push-docker:
    needs: build
    if: |
      always() && 
      (needs.build.result == 'success' || needs.build.result == 'skipped') &&
      (github.event_name == 'release' || github.event_name == 'prerelease' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts from Build
        if: needs.build.result == 'success'
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Download artifacts from Release/Prerelease
        if: github.event_name == 'workflow_dispatch' && (inputs.source == 'release' || inputs.source == 'prerelease')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create artifact directories for all architectures
          mkdir -p artifacts/cli-linux-amd64 artifacts/monitor-linux-amd64
          mkdir -p artifacts/cli-linux-arm64 artifacts/monitor-linux-arm64
          mkdir -p artifacts/cli-linux-386 artifacts/monitor-linux-386
          mkdir -p artifacts/cli-linux-arm7 artifacts/monitor-linux-arm7
          mkdir -p artifacts/cli-linux-arm6 artifacts/monitor-linux-arm6
          mkdir -p artifacts/cli-linux-ppc64le artifacts/monitor-linux-ppc64le
          mkdir -p artifacts/cli-linux-s390x artifacts/monitor-linux-s390x
          mkdir -p artifacts/cli-linux-riscv64 artifacts/monitor-linux-riscv64
          
          # Determine target tag
          TARGET_TAG=""
          if [ "${{ inputs.source }}" == "prerelease" ]; then
             echo "Fetching latest prerelease tag..."
             TARGET_TAG=$(gh release list --limit 1 --exclude-drafts --prerelease --json tagName -q '.[0].tagName')
             echo "Latest prerelease tag: $TARGET_TAG"
          fi

          # Download specific Linux assets
          # We need to cover all supported unix platforms
          ARGS=(-p "*linux_amd64" -p "*linux_arm64" -p "*linux_386" -p "*linux_arm7" -p "*linux_arm6" -p "*linux_ppc64le" -p "*linux_s390x" -p "*linux_riscv64")
          if [ -n "$TARGET_TAG" ]; then
            ARGS+=("$TARGET_TAG")
          fi
          
          gh release download "${ARGS[@]}"
          
          # Move files to expected artifact structure
          # Helper function to move files
          move_file() {
            local pattern=$1
            local dest=$2
            mv $pattern $dest/ 2>/dev/null || true
          }

          move_file "unlock-test_linux_amd64" "artifacts/cli-linux-amd64"
          move_file "unlock-test_linux_arm64" "artifacts/cli-linux-arm64"
          move_file "unlock-test_linux_386" "artifacts/cli-linux-386"
          move_file "unlock-test_linux_arm7" "artifacts/cli-linux-arm7"
          move_file "unlock-test_linux_arm6" "artifacts/cli-linux-arm6"
          move_file "unlock-test_linux_ppc64le" "artifacts/cli-linux-ppc64le"
          move_file "unlock-test_linux_s390x" "artifacts/cli-linux-s390x"
          move_file "unlock-test_linux_riscv64" "artifacts/cli-linux-riscv64"

          move_file "unlock-monitor_linux_amd64" "artifacts/monitor-linux-amd64"
          move_file "unlock-monitor_linux_arm64" "artifacts/monitor-linux-arm64"
          move_file "unlock-monitor_linux_386" "artifacts/monitor-linux-386"
          move_file "unlock-monitor_linux_arm7" "artifacts/monitor-linux-arm7"
          move_file "unlock-monitor_linux_arm6" "artifacts/monitor-linux-arm6"
          move_file "unlock-monitor_linux_ppc64le" "artifacts/monitor-linux-ppc64le"
          move_file "unlock-monitor_linux_s390x" "artifacts/monitor-linux-s390x"
          move_file "unlock-monitor_linux_riscv64" "artifacts/monitor-linux-riscv64"

      - name: Prepare Docker Context
        run: |
          # Create context directories for all architectures and variants
          # Structure: docker/context/{project}/linux/{arch}/{variant}
          
          prepare_context() {
            local project=$1
            local artifact_arch=$2
            local docker_arch=$3
            local docker_variant=$4
            
            local src_dir="artifacts/${project}-linux-${artifact_arch}"
            # Flatten context structure
            local dest_dir="docker/context/${project}"
            
            mkdir -p "$dest_dir"
            
            # Find the binary
            local bin_file=$(find "$src_dir" -name "unlock-*" -type f | head -n 1)
            
            if [ -f "$bin_file" ]; then
              # Naming convention: bin-linux-{arch}{variant}
              # e.g., bin-linux-amd64, bin-linux-armv7
              local target_name="bin-linux-${docker_arch}${docker_variant}"
              
              cp "$bin_file" "$dest_dir/$target_name"
              chmod +x "$dest_dir/$target_name"
              echo "Prepared $project for linux/${docker_arch}/${docker_variant} as $target_name from $bin_file"
            else
              echo "Warning: No binary found for $project in $src_dir"
            fi
          }

          # CLI
          prepare_context "cli" "amd64" "amd64" ""
          prepare_context "cli" "arm64" "arm64" ""
          prepare_context "cli" "386" "386" ""
          prepare_context "cli" "arm7" "arm" "v7"
          prepare_context "cli" "arm6" "arm" "v6"
          prepare_context "cli" "ppc64le" "ppc64le" ""
          prepare_context "cli" "s390x" "s390x" ""
          prepare_context "cli" "riscv64" "riscv64" ""

          # Monitor
          prepare_context "monitor" "amd64" "amd64" ""
          prepare_context "monitor" "arm64" "arm64" ""
          prepare_context "monitor" "386" "386" ""
          prepare_context "monitor" "arm7" "arm" "v7"
          prepare_context "monitor" "arm6" "arm" "v6"
          prepare_context "monitor" "ppc64le" "ppc64le" ""
          prepare_context "monitor" "s390x" "s390x" ""
          prepare_context "monitor" "riscv64" "riscv64" ""

      - name: Generate Docker Tags
        id: generate-tags
        run: |
          # Initialize variables
          DATE_TS=$(date +%s)
          TAGS_CLI=""
          TAGS_MONITOR=""
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # Function to add tag
          add_tag() {
            local tag=$1
            TAGS_CLI="${TAGS_CLI}ghcr.io/${REPO_OWNER}/unlock-test:${tag},"
            TAGS_MONITOR="${TAGS_MONITOR}ghcr.io/${REPO_OWNER}/unlock-monitor:${tag},"
          }

          if [ "${{ github.event_name }}" == "release" ] || [ "${{ github.event_name }}" == "prerelease" ]; then
            # Release/Prerelease logic
            RAW_TAG="${{ github.event.release.tag_name }}"
            CLEAN_VERSION=$(echo "$RAW_TAG" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+).*/v\1/')
            
            # 1. Full tag (e.g. v1.8.5-1770436107)
            add_tag "$RAW_TAG"
            
            # 2. Clean version (e.g. v1.8.5) if different
            if [ "$RAW_TAG" != "$CLEAN_VERSION" ]; then
              add_tag "$CLEAN_VERSION"
            fi
            
            # 3. release/prerelease/latest logic
            if [ "${{ github.event.release.prerelease }}" == "true" ]; then
              add_tag "prerelease"
            else
              add_tag "release"
              add_tag "latest"
            fi
            
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SOURCE="${{ inputs.source }}"
            
            if [ "$SOURCE" == "build" ]; then
              # Build from source -> -dirty tags
              # Extract version from file since we don't have a release tag
              # We need to look at checks/mediaunlock.go or VERSION file
              # Assuming VERSION file exists or extracting from file like update-version job
              if [ -f "VERSION" ]; then
                VERSION=$(cat VERSION)
              else
                 # Fallback extract from mediaunlock.go
                 VERSION=$(grep '^[[:space:]]*Version[[:space:]]*=' checks/mediaunlock.go | sed -E 's/.*Version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/')
              fi
              
              add_tag "preview"
              add_tag "v${VERSION}-dirty"
              add_tag "v${VERSION}-${DATE_TS}-dirty"
              
            elif [ "$SOURCE" == "release" ]; then
              # Release source -> latest
              add_tag "latest"
              
            elif [ "$SOURCE" == "prerelease" ]; then
              # Prerelease source -> custom tag
              add_tag "${{ inputs.tag }}"
            fi
          fi

          # Remove trailing commas
          TAGS_CLI=${TAGS_CLI%,}
          TAGS_MONITOR=${TAGS_MONITOR%,}
          
          echo "Generated CLI Tags: $TAGS_CLI"
          echo "Generated Monitor Tags: $TAGS_MONITOR"
          
          echo "tags_cli=$TAGS_CLI" >> $GITHUB_OUTPUT
          echo "tags_monitor=$TAGS_MONITOR" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push CLI Docker image
        uses: docker/build-push-action@v5
        with:
          context: docker/context/cli
          file: docker/Dockerfile.cli
          platforms: linux/amd64,linux/arm64,linux/386,linux/arm/v7,linux/arm/v6,linux/ppc64le,linux/s390x,linux/riscv64
          push: true
          tags: ${{ steps.generate-tags.outputs.tags_cli }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}

      - name: Build and push Monitor Docker image
        uses: docker/build-push-action@v5
        with:
          context: docker/context/monitor
          file: docker/Dockerfile.monitor
          platforms: linux/amd64,linux/arm64,linux/386,linux/arm/v7,linux/arm/v6,linux/ppc64le,linux/s390x,linux/riscv64
          push: true
          tags: ${{ steps.generate-tags.outputs.tags_monitor }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
